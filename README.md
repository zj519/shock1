# Shock Wave Simulation in N₂/n-Dodecane Mixture

Molecular dynamics simulation of shock wave propagation through a gas mixture of N₂ and C₁₂H₂₆ using LAMMPS with the L-OPLSAA2024 force field.

## System Description

- **Composition**: 880 N₂ molecules + 10 C₁₂H₂₆ molecules (X_N₂ = 88/89)
- **Total atoms**: 2,140 gas atoms + 490,000 piston atoms
- **Box dimensions**: 3698 Å × 1400 Å × 1400 Å (10δ × 10λ × 10λ)
  - λ = 14 nm (characteristic length scale)
  - δ = 37 nm (shock front thickness scale)
- **Boundary conditions**: Fixed (non-periodic) in x, periodic in y and z
- **Force field**: L-OPLSAA2024 for dodecane, custom Bouanich potential for N₂
- **Initial conditions**: T = 300 K, P ≈ 5 atm

## Prerequisites

### Software Requirements

- **LAMMPS** (compiled with KSPACE, MOLECULE, MANYBODY packages)
- **moltemplate** (for system generation)
- **Python 3** (for data processing scripts)
- **SLURM** (for job submission on HPC clusters)

### Compiling LAMMPS with Required Packages

```bash
cd ~/lammps/src
make yes-kspace
make yes-molecule
make yes-manybody
make -j8 mpi
```

### Key LAMMPS Features Used

- `pair_style lj/cut/coul/cut` - Cutoff-based Lennard-Jones and Coulombic interactions
- `bond_style harmonic` - Harmonic bonds
- `angle_style harmonic` - Harmonic angles
- `dihedral_style opls` - OPLS dihedral potential
- `improper_style cvff` - CVFF improper torsions

## File Structure

### Required Input Files

#### 1. Molecule Definition Files

**N2.lt** - Nitrogen molecule definition
- 2 atoms per molecule
- Bond length: 1.10 Å
- Bouanich site-site LJ parameters (ε = 0.073856 kcal/mol, σ = 3.29013 Å)
- Non-polar (zero charge)

**C12H26.lt** - n-Dodecane molecule definition
- 38 atoms per molecule (12 C + 26 H)
- Uses L-OPLSAA2024 force field atom types
- Imports from: `/home1/zimengji/moltemplate/moltemplate/force_fields/loplsaa2024.lt`

#### 2. System Definition

**system.lt** - Complete system setup
- Imports N2.lt and C12H26.lt
- Defines simulation box
- Sets force field styles
- Creates 880 N₂ + 10 C₁₂H₂₆ molecules
- **Important**: Uses periodic boundaries during generation

#### 3. Main Simulation Input

**in.shock** - LAMMPS input script
- Reads system.data generated by moltemplate
- Displaces atoms randomly to fill box
- Changes to fixed boundary conditions
- Runs equilibration (NVT + NVE)
- Creates piston and runs shock simulation

### Generated Files

After running moltemplate:
- `system.data` - Initial atomic coordinates and topology
- `system.in.init` - Force field style definitions
- `system.in.settings` - Force field parameters (pair_coeff, bond_coeff, etc.)

After fixing atom positions:
- `system_fixed.data` - Atoms spread on grid (no overlaps)

During simulation:
- `data.preshock` - Equilibrated system before shock
- `data.postshock` - Final system after shock
- `shock.log` - LAMMPS output log
- `T_profile.out` - Temperature vs position
- `T_n2_profile.out` - N₂ temperature profile
- `T_fuel_profile.out` - Dodecane temperature profile

## Step-by-Step Instructions

### Step 1: Generate Initial System with Moltemplate

```bash
# Run moltemplate to create system files
moltemplate.sh system.lt
```

**Output**: `system.data`, `system.in.init`, `system.in.settings`

**Problem**: Atoms are created at origin (0,0,0) causing massive overlaps!

### Step 2: Fix Atom Positions

Since moltemplate places all molecules at the origin, we need to spread them throughout the box:

```bash
# Run the Python script to distribute atoms on a grid
python3 fix_system_data.py
```

**Input**: `system.data`  
**Output**: `system_fixed.data` (atoms distributed on 22×20×2 grid)

This script:
- Reads system.data
- Places each molecule at a unique grid position
- Maintains relative atomic positions within molecules
- Prevents overlapping atoms

### Step 3: Run the Simulation

#### Option A: Interactive Run (for testing)

```bash

# Run LAMMPS
OMP_NUM_THREADS=8 lmp -in in.shock -log shock.log
```

#### Option B: SLURM Batch Job (recommended)

```bash
# Submit job to cluster
sbatch run_shock.slurm

# Monitor job status
squeue -u zimengji

# Watch progress
tail -f shock.log
```

### Step 4: Monitor Progress

```bash
# Run the monitoring script in a separate terminal
./monitor_shock_progress.sh
```

**Output**:
```
Equilibrating... Step: 150000/240000 (62.5%)
Shock Stage - Step: 45000/100000 (45.0%) | ETA: 0h 35m 12s
```

## Simulation Stages

### Stage 1: NVT Equilibration 
- Timestep: 100,000 steps
- Temperature: 300 K 
- Purpose: Thermalize system, achieve target temperature

### Stage 3: NVE Equilibration
- Microcanonical ensemble (constant energy)
- Timestep: 100,000 steps
- Purpose: Verify energy conservation, check equilibration

### Stage 4: Shock Wave (100,000 steps)
- Create piston: 490,000 atoms at x = 0-2 Å
- Piston velocity: 0.01765 Å/timestep = 1765 m/s
- Piston moves in +x direction, compressing gas
- Temperature jumps from ~300 K to thousands of K behind shock front

## Key Parameters

### Piston Configuration
- **Type**: 1001 (custom type to avoid conflicts)
- **Mass**: 14.007 amu (same as nitrogen)
- **Region**: x ∈ [0, 2] Å, y ∈ [0, 1400] Å, z ∈ [0, 1400] Å
- **Velocity**: 0.01765 Å/timestep
- **Lattice**: Simple cubic with 2 Å spacing

### Cutoffs and Neighbor Lists
- **LJ cutoff**: 13.0 Å
- **Coulomb cutoff**: 30.0 Å
- **Neighbor list**: Skin distance = 3.0 Å
- **Special settings**: `neigh_modify one 4000 page 400000` (for high density)

### Output Frequency
- **Thermo output**: Every 1000 steps
- **Temperature profiles**: Averaged every 10,000 steps (100 samples × 100 steps)
- **Spatial bins**: 200 bins across x-direction (~18.5 Å per bin)

## Troubleshooting

### Issue 1: "Did not assign all atoms correctly"

**Cause**: Atoms outside simulation box with non-periodic boundaries

**Solution**: 
1. Use `boundary p p p` in system.lt during generation
2. Run moltemplate
3. Use `displace_atoms random` or fix_system_data.py to spread atoms
4. Change to `boundary f p p` in LAMMPS input

### Issue 2: "Neighbor list overflow"

**Cause**: Too many neighbors per atom (high density after displacement)

**Solution**: Add to input file:
```lammps
neigh_modify one 4000 page 400000
```

### Issue 3: "Cannot use non-periodic boundaries with PPPM"

**Cause**: L-OPLSAA force field uses `lj/charmm/coul/long` requiring PPPM

**Solution**: Override pair style after including system.in.init:
```lammps
pair_style lj/cut/coul/cut 13.0 30.0
pair_modify mix geometric
kspace_style none
```

### Issue 4: "Fix ave/spatial is deprecated"

**Cause**: Using old LAMMPS syntax

**Solution**: Replace with compute chunk/atom + fix ave/chunk (see in.shock)

### Issue 5: Simulation explodes (nan values)

**Cause**: Atoms too close together causing infinite forces

**Solution**:
1. Use fix_system_data.py to properly space atoms
2. Add minimization before MD
3. Use smaller initial timestep (0.1 fs)

### Issue 6: "Cannot create atoms with undefined lattice"

**Cause**: create_atoms for piston needs lattice definition

**Solution**: Add before create_atoms:
```lammps
lattice sc 2.0
```

## Performance Optimization

### Strong Scaling Test

To find optimal number of OpenMP threads:

```bash
# Submit scaling test
sbatch scaling_test.slurm

# Analyze results
./analyze_scaling.sh
```

**Expected results**:
- 1-4 threads: Near-linear speedup
- 8-12 threads: Diminishing returns
- 16+ threads: Minimal improvement


## Expected Results

### Temperature Jump
- Pre-shock: T1 ≈ 300 K
- Post-shock: T2 ≈ 5.8T1 K (depends on piston velocity)


### Pressure Jump
- Pre-shock: P1 ≈ 5 atm (low density)
- Post-shock: P2 ≈ 29P1

## Data Analysis

### Plotting Temperature Profiles

```python
import numpy as np
import matplotlib.pyplot as plt

# Read temperature profile
data = np.loadtxt('T_profile.out', skiprows=4)
x_position = data[:, 1]  # Bin coordinate
temperature = data[:, 2]  # Average temperature

plt.plot(x_position, temperature)
plt.xlabel('Position (Å)')
plt.ylabel('Temperature (K)')
plt.title('Shock Wave Temperature Profile')
plt.show()
```

### Identifying Shock Front

The shock front is where temperature/density/pressure jump sharply.

## References

### N₂ Potential
- Bouanich site-site LJ parameters
- Reference: Table 1, exact site-site LJ potential, 200-500K

### Dodecane Potential
- L-OPLSAA2024 force field
- Improved OPLS parameters for linear alkanes

### LAMMPS Documentation
- https://docs.lammps.org
- https://docs.lammps.org/err0016 (Atom assignment errors)
- https://docs.lammps.org/err0036 (Neighbor list overflow)
